<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gene Sequence 3D Visualization</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
        }
        
        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        #info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 300px;
            backdrop-filter: blur(10px);
            z-index: 100;
        }
        
        #info-panel h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #4ecca3;
        }
        
        #info-panel p {
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            z-index: 100;
        }
        
        .controls button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s;
        }
        
        .controls button:hover {
            transform: scale(1.05);
        }
        
        .controls button:active {
            transform: scale(0.95);
        }
        
        #legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            z-index: 100;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        #legend h3 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #4ecca3;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 12px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 10px;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            text-align: center;
            z-index: 1000;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <div>Loading Gene Sequence...</div>
    </div>
    
    <div id="canvas-container"></div>
    
    <div id="info-panel">
        <h1>üß¨ Gene Sequence Visualization</h1>
        <p><strong>Gene:</strong> <span id="gene-name">C2 domain-containing protein</span></p>
        <p><strong>Species:</strong> <span id="species">Malus domestica</span></p>
        <p><strong>Length:</strong> <span id="sequence-length">0</span> amino acids</p>
        <p><strong>Visualization:</strong> 3D Double Helix</p>
        <p style="font-size: 12px; margin-top: 15px; color: #aaa;">
            Use mouse to rotate, scroll to zoom, right-click to pan
        </p>
    </div>
    
    <div class="controls">
        <button onclick="toggleAnimation()">‚èØÔ∏è Toggle Animation</button>
        <button onclick="changeVisualization()">üîÑ Change View</button>
        <button onclick="resetCamera()">üì∑ Reset Camera</button>
        <button onclick="toggleParticles()">‚ú® Toggle Particles</button>
    </div>
    
    <div id="legend">
        <h3>Amino Acid Legend</h3>
        <div id="legend-content"></div>
    </div>
    
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        
        // Gene sequence data - using the first gene from the CSV
        const geneSequence = `MSKSFFACKLCSRKKRIALVVQVKHFNQNYKNALVMNAGIFKTIKVCAFLGTREAFKVAP
MKSQAAPNQEDYKLKDTKPRLGERWPHGGVRGGGGWISSERATSTYDLVEQMFYLYVRVE
KAKDLPTNPVTGSCDPYIEVKLGNYKGKTKHFEKKTNPEWKQVFAFSKEKIQSSILEVYV
RDREMVARDDNVGKVVFDMNEVPTRVPPDSPLAPQWYRLEDRRGDTKVRGEVMLAVWMGT
QADEAFPEAWHSDAASVHGEGVFSIRSKVYVSPKLWYLRVNVIEAQDVEPHDRSQLPQAF
IKAHVGNQTLKTKISPTRTPNPMWNEDLIFVAAEPFEEQLVLTVENKVSAAKDEQVGKIS
LPLTIFERRLDHRPVHSHWFNLEKFGFGALEGDKRHELKFSTRVHLRVCLEGAYHVLDES
TLYISDVRPTARQLWKQPIGILETVAGDIATQGERFQAVLSWRDPRASSLFVFLCLIAAV
VLYVTPFKMIALATGIVWLRHPRFRSKLPSVPSNFFRRLPSCADSML`.replace(/\n/g, '');
        
        // Amino acid color mapping with beautiful colors
        const aminoAcidColors = {
            'A': 0xFF6B6B, 'R': 0x4ECDC4, 'N': 0x45B7D1, 'D': 0xF7DC6F,
            'C': 0xBB8FCE, 'E': 0xF8B739, 'Q': 0x52B788, 'G': 0xFF8C42,
            'H': 0x5DADE2, 'I': 0xEC7063, 'L': 0x85C1E2, 'K': 0xF06292,
            'M': 0xBA68C8, 'F': 0x4DB6AC, 'P': 0xFFD54F, 'S': 0x81C784,
            'T': 0x64B5F6, 'W': 0x9575CD, 'Y': 0xFFB74D, 'V': 0xF06292
        };
        
        // Scene setup
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0a1a);
        scene.fog = new THREE.Fog(0x0a0a1a, 50, 200);
        
        const camera = new THREE.PerspectiveCamera(
            75,
            window.innerWidth / window.innerHeight,
            0.1,
            1000
        );
        camera.position.set(0, 30, 80);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.getElementById('canvas-container').appendChild(renderer.domElement);
        
        // Post-processing for glow effect
        const composer = new EffectComposer(renderer);
        const renderPass = new RenderPass(scene, camera);
        composer.addPass(renderPass);
        
        const bloomPass = new UnrealBloomPass(
            new THREE.Vector2(window.innerWidth, window.innerHeight),
            1.5, 0.4, 0.85
        );
        composer.addPass(bloomPass);
        
        // Controls
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.rotateSpeed = 0.5;
        
        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        
        const pointLight1 = new THREE.PointLight(0x4ecca3, 2, 100);
        pointLight1.position.set(50, 50, 50);
        scene.add(pointLight1);
        
        const pointLight2 = new THREE.PointLight(0x667eea, 2, 100);
        pointLight2.position.set(-50, -50, -50);
        scene.add(pointLight2);
        
        // Create DNA helix structure
        const helixGroup = new THREE.Group();
        const particleGroup = new THREE.Group();
        let animationEnabled = true;
        let visualizationMode = 0; // 0: helix, 1: sphere, 2: wave
        
        function createDNAHelix() {
            const radius = 10;
            const height = geneSequence.length * 0.5;
            const turns = 8;
            
            // Clear existing geometry
            while(helixGroup.children.length > 0) {
                helixGroup.remove(helixGroup.children[0]);
            }
            
            // Create backbone strands
            const curve1Points = [];
            const curve2Points = [];
            
            for (let i = 0; i < geneSequence.length; i++) {
                const t = i / geneSequence.length;
                const angle = t * Math.PI * 2 * turns;
                const y = (t - 0.5) * height;
                
                curve1Points.push(new THREE.Vector3(
                    Math.cos(angle) * radius,
                    y,
                    Math.sin(angle) * radius
                ));
                
                curve2Points.push(new THREE.Vector3(
                    Math.cos(angle + Math.PI) * radius,
                    y,
                    Math.sin(angle + Math.PI) * radius
                ));
            }
            
            const curve1 = new THREE.CatmullRomCurve3(curve1Points);
            const curve2 = new THREE.CatmullRomCurve3(curve2Points);
            
            // Create tube geometry for strands
            const tubeGeometry1 = new THREE.TubeGeometry(curve1, 400, 0.3, 8, false);
            const tubeGeometry2 = new THREE.TubeGeometry(curve2, 400, 0.3, 8, false);
            
            const strandMaterial1 = new THREE.MeshPhongMaterial({
                color: 0x4ecca3,
                emissive: 0x4ecca3,
                emissiveIntensity: 0.2,
                shininess: 100
            });
            
            const strandMaterial2 = new THREE.MeshPhongMaterial({
                color: 0x667eea,
                emissive: 0x667eea,
                emissiveIntensity: 0.2,
                shininess: 100
            });
            
            const strand1 = new THREE.Mesh(tubeGeometry1, strandMaterial1);
            const strand2 = new THREE.Mesh(tubeGeometry2, strandMaterial2);
            
            helixGroup.add(strand1);
            helixGroup.add(strand2);
            
            // Create base pairs (amino acids)
            for (let i = 0; i < geneSequence.length; i += 2) {
                const aa = geneSequence[i];
                const color = aminoAcidColors[aa] || 0xffffff;
                
                const point1 = curve1Points[i];
                const point2 = curve2Points[i];
                
                // Create connecting line
                const lineGeometry = new THREE.BufferGeometry().setFromPoints([point1, point2]);
                const lineMaterial = new THREE.LineBasicMaterial({ 
                    color: color,
                    opacity: 0.6,
                    transparent: true
                });
                const line = new THREE.Line(lineGeometry, lineMaterial);
                helixGroup.add(line);
                
                // Create sphere at base pair position
                const sphereGeometry = new THREE.SphereGeometry(0.5, 16, 16);
                const sphereMaterial = new THREE.MeshPhongMaterial({
                    color: color,
                    emissive: color,
                    emissiveIntensity: 0.3
                });
                
                const sphere1 = new THREE.Mesh(sphereGeometry, sphereMaterial);
                sphere1.position.copy(point1);
                helixGroup.add(sphere1);
                
                const sphere2 = new THREE.Mesh(sphereGeometry.clone(), sphereMaterial.clone());
                sphere2.position.copy(point2);
                helixGroup.add(sphere2);
            }
        }
        
        function createParticleVisualization() {
            while(particleGroup.children.length > 0) {
                particleGroup.remove(particleGroup.children[0]);
            }
            
            const particleCount = geneSequence.length;
            const positions = new Float32Array(particleCount * 3);
            const colors = new Float32Array(particleCount * 3);
            
            for (let i = 0; i < particleCount; i++) {
                const aa = geneSequence[i];
                const color = new THREE.Color(aminoAcidColors[aa] || 0xffffff);
                
                // Random position in sphere
                const radius = 30;
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);
                
                positions[i * 3] = radius * Math.sin(phi) * Math.cos(theta);
                positions[i * 3 + 1] = radius * Math.sin(phi) * Math.sin(theta);
                positions[i * 3 + 2] = radius * Math.cos(phi);
                
                colors[i * 3] = color.r;
                colors[i * 3 + 1] = color.g;
                colors[i * 3 + 2] = color.b;
            }
            
            const geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            
            const material = new THREE.PointsMaterial({
                size: 1.5,
                vertexColors: true,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending
            });
            
            const particles = new THREE.Points(geometry, material);
            particleGroup.add(particles);
        }
        
        // Initialize visualizations
        createDNAHelix();
        createParticleVisualization();
        scene.add(helixGroup);
        scene.add(particleGroup);
        particleGroup.visible = false;
        
        // Update UI
        document.getElementById('sequence-length').textContent = geneSequence.length;
        
        // Create legend
        const legendContent = document.getElementById('legend-content');
        const uniqueAminoAcids = [...new Set(geneSequence.split(''))];
        uniqueAminoAcids.sort();
        
        const aminoAcidNames = {
            'A': 'Alanine', 'R': 'Arginine', 'N': 'Asparagine', 'D': 'Aspartic acid',
            'C': 'Cysteine', 'E': 'Glutamic acid', 'Q': 'Glutamine', 'G': 'Glycine',
            'H': 'Histidine', 'I': 'Isoleucine', 'L': 'Leucine', 'K': 'Lysine',
            'M': 'Methionine', 'F': 'Phenylalanine', 'P': 'Proline', 'S': 'Serine',
            'T': 'Threonine', 'W': 'Tryptophan', 'Y': 'Tyrosine', 'V': 'Valine'
        };
        
        uniqueAminoAcids.forEach(aa => {
            const item = document.createElement('div');
            item.className = 'legend-item';
            
            const colorBox = document.createElement('div');
            colorBox.className = 'legend-color';
            colorBox.style.backgroundColor = '#' + (aminoAcidColors[aa] || 0xffffff).toString(16).padStart(6, '0');
            
            const label = document.createElement('span');
            label.textContent = `${aa} - ${aminoAcidNames[aa] || 'Unknown'}`;
            
            item.appendChild(colorBox);
            item.appendChild(label);
            legendContent.appendChild(item);
        });
        
        // Animation loop
        let time = 0;
        function animate() {
            requestAnimationFrame(animate);
            
            if (animationEnabled) {
                time += 0.005;
                helixGroup.rotation.y = time;
                particleGroup.rotation.y = time * 0.5;
                particleGroup.rotation.x = time * 0.3;
            }
            
            controls.update();
            composer.render();
        }
        
        // Control functions
        window.toggleAnimation = function() {
            animationEnabled = !animationEnabled;
        };
        
        window.changeVisualization = function() {
            visualizationMode = (visualizationMode + 1) % 2;
            if (visualizationMode === 0) {
                helixGroup.visible = true;
                particleGroup.visible = false;
            } else {
                helixGroup.visible = false;
                particleGroup.visible = true;
            }
        };
        
        window.resetCamera = function() {
            camera.position.set(0, 30, 80);
            controls.reset();
        };
        
        window.toggleParticles = function() {
            particleGroup.visible = !particleGroup.visible;
        };
        
        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // Hide loading screen and start animation
        setTimeout(() => {
            document.getElementById('loading').style.display = 'none';
            animate();
        }, 1000);
    </script>
</body>
</html>
